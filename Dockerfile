# =============================================
#  Базовый образ Python (официальный, slim-версия)
# =============================================
FROM python:3.13-slim

# =============================================
#  Установка зависимостей ОС + supervisord
# =============================================
RUN apt-get update && apt-get install -y supervisor && \
    # Чистка кеша apt для уменьшения размера образа:
    rm -rf /var/lib/apt/lists/* && \
    # Проверяем версию supervisord (для отладки):
    supervisord --version

# =============================================
#  Рабочая директория и копирование кода
# =============================================
WORKDIR /app

# Сначала копируем только requirements.txt для лучшего кеширования слоев
COPY requirements.txt .

# Установка Python-зависимостей с очисткой кеша pip
RUN pip install --no-cache-dir -r requirements.txt && \
    # Фиксация версий пакетов (опционально, для reproducibility):
    pip freeze > /tmp/requirements.freeze

# Копируем ВЕСЬ проект (кроме указанного в .dockerignore)
COPY . .

# =============================================
#  Настройка supervisord
# =============================================
# Копируем конфиг (путь должен совпадать с указанным в CMD)
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

# =============================================
#  Сетевые настройки и точка входа
# =============================================
# Документируем используемый порт (не открывает порт автоматически)
EXPOSE 8000

# Запускаем supervisord в foreground-режиме:
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor/conf.d/supervisord.conf", "-n"]